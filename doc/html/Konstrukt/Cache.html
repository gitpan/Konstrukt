<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><title>Konstrukt::Cache</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="cpan" type="text/css" href="../cpan.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::CustomHTML v,
  using Pod::Simple::PullParser v2.02,
  under Perl v5.008008 at Tue Sep 26 20:07:24 2006 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::CustomHTML, and/or subclassing Pod::Simple::CustomHTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::CustomHTML for advice.
   See 'perldoc Pod::Simple::CustomHTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#TRACKED_FILES_%2F_TO_WHICH_FILES_ARE_THE_CONDITIONS_APPLIED%3F'>TRACKED FILES / TO WHICH FILES ARE THE CONDITIONS APPLIED?</a>
  <li class='indexItem indexItem1'><a href='#CONFIGURATION'>CONFIGURATION</a>
  <li class='indexItem indexItem1'><a href='#METHODS'>METHODS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#new'>new</a>
    <li class='indexItem indexItem2'><a href='#init'>init</a>
    <li class='indexItem indexItem2'><a href='#add_condition_file'>add_condition_file</a>
    <li class='indexItem indexItem2'><a href='#add_condition_date'>add_condition_date</a>
    <li class='indexItem indexItem2'><a href='#add_condition_sql'>add_condition_sql</a>
    <li class='indexItem indexItem2'><a href='#add_condition_sql_advanced'>add_condition_sql_advanced</a>
    <li class='indexItem indexItem2'><a href='#add_condition_perl'>add_condition_perl</a>
    <li class='indexItem indexItem2'><a href='#prevent_caching'>prevent_caching</a>
    <li class='indexItem indexItem2'><a href='#validate_cache'>validate_cache</a>
    <li class='indexItem indexItem2'><a href='#get_cache'>get_cache</a>
    <li class='indexItem indexItem2'><a href='#write_cache'>write_cache</a>
    <li class='indexItem indexItem2'><a href='#delete_cache'>delete_cache</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>Konstrukt::Cache - Caching functionalities</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>        #read and track a file/some files. only files that have been read with the
        #L&#60;Konstrukt::File/read_and_track&#62; method will be tracked for caching and the
        #cache conditions will only be saved for this files.
        $Konstrukt::File-&#62;read_and_track(&#39;/some/file&#39;); #will be $docroot/some/file
        $Konstrukt::File-&#62;read_and_track(&#39;another_file&#39;); #will be $docroot/some/another_file
        
        #check that this file has not been changed
        $Konstrukt::Cache-&#62;add_condition_file(&#60;filename of the file that should be cached&#62;, &#60;filename of the file that must not change&#62;);
        
        #check that this date is not reached
        #format:
        #YYYY-MM-DD-HH-MM-SS (absolute date)
        #+1Y, 1M, 1D, 1H, 1M, 1S (relative date)
        $Konstrukt::Cache-&#62;add_condition_date(&#60;filename of the file that should be cached&#62;, &#60;date in format as stated above&#62;);
        
        #check that the sql table didn&#39;t change
        #will use the sql-connection-settings from your konstrukt.config. see Konstrukt::Plugin::sql
        $Konstrukt::Cache-&#62;add_condition_sql(&#60;filename of the file that should be cached&#62;, &#60;table&#62;);
        #will use the specified sql-connection-settings
        $Konstrukt::Cache-&#62;add_condition_sql_advanced(&#60;filename of the file that should be cached&#62;, &#60;dbi-source&#62;, &#60;dbi-user&#62;, &#60;dbi-pass&#62;, &#60;table&#62;);
        
        #check that this sub returns true.
        #this is the most flexible but also least comfortable way to validate the cache.
        $Konstrukt::Cache-&#62;add_condition_perl(&#60;filename of the file that should be cached&#62;, &#34;&#60;perl-code here&#62;&#34;);
        
        #prevent caching of the file. if you don&#39;t want this file to be cached for some reason.
        $Konstrukt::Cache-&#62;prevent_caching(&#60;filename of the file that must not be cached&#62;);
        
        #write the cache
        $Konstrukt::Cache-&#62;write_cache($Konstrukt::File-&#62;absolute_path(&#60;filename of the file that must not be cached&#62;), &#60;parse tree&#62;);

        #read the cache
        my $parse_tree = $Konstrukt::Cache-&#62;get_cache($Konstrukt::File-&#62;absolute_path(&#60;filename of the file that must not be cached&#62;));
        
        #delete the cache. generally only used internally
        $Konstrukt::Cache-&#62;delete_cache($Konstrukt::File-&#62;absolute_path(&#60;filename of the file that must not be cached&#62;));</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module provides the caching functionality of this framework. It&#39;s one key element to a higher performance, so the usage is recommended.</p>

<p>After the <i>prepare</i>-run the result will be cached, so that on a second request for this file the prepare-work won&#39;t be done again.</p>

<p>You can add conditions to the cached results that must be fulfilled to accept the cached result as up-to-date.</p>

<p>For example you may specify an input file that must not change (<a href="#add_condition_file" class="podlinkpod"
>&#34;add_condition_file&#34;</a>). If the file was modified its date will change, the cache will get invalid and the source file has to be processed from the start.</p>

<p>For more possibilities take a look at <a href="#SYNOPSIS" class="podlinkpod"
>&#34;SYNOPSIS&#34;</a>.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="TRACKED_FILES_/_TO_WHICH_FILES_ARE_THE_CONDITIONS_APPLIED?"
>TRACKED FILES / TO WHICH FILES ARE THE CONDITIONS APPLIED?</a></h1>

<p>Only files that have been read with the <a href="../Konstrukt/File.html#read_and_track" class="podlinkpod"
>&#34;read_and_track&#34; in Konstrukt::File</a> method will be tracked for caching and the cache conditions will only be saved for this files.</p>

<p>Let&#39;s say you read those three files:</p>

<pre>        $Konstrukt::File-&#62;read_and_track(&#39;/some/file&#39;);   #1) will be $docroot/some/file
        $Konstrukt::File-&#62;read_and_track(&#39;another_file&#39;); #2) will be $docroot/some/another_file
        $Konstrukt::File-&#62;read(&#39;even_another_file&#39;);      #3) will be $docroot/some/even_another_file</pre>

<p>Then you add a date condition:</p>

<pre>        $Konstrukt::Cache-&#62;add_condition_date(&#34;+5m&#34;); #cache valid for max. 5 minutes</pre>

<p>This condition will be added to file 1) and 2). Not to file 3) as it is not tracked (i.e. not push()&#39;ed on Konstrukt::File&#39;s file stack).</p>

<p>Then you&#39;re done with file 2) and remove it from Konstrukt::File&#39;s stack:</p>

<pre>        $Konstrukt::File-&#62;pop();</pre>

<p>Now you add another date condition:</p>

<pre>        $Konstrukt::Cache-&#62;add_condition_date(&#34;+2m&#34;); #cache valid for max. 2 minutes</pre>

<p>This condition will only be added to file 1), as file 2) isn&#39;t tracked anymore. Note also that only earlier dates will be added. A later date won&#39;t be added as the file already gets invalid by the earlier date condition.</p>

<p>Note: When a new file is read (with <a href="../Konstrukt/File/read_and_track.html" class="podlinkpod"
>Konstrukt::File::read_and_track</a>) a file date condition will automatically added to each tracked file as it is supposed that the file depends on the files which have been read as the file was tracked. See also <a href="../Konstrukt/File/read_and_track.html" class="podlinkpod"
>Konstrukt::File::read_and_track</a>.</p>

<p>Now you might want to write the cache:</p>

<pre>        $Konstrukt::Cache-&#62;write_cache($Konstrukt::File-&#62;absolute_path(&#39;/some/file&#39;),        &#60;parse tree 1&#62;);
        $Konstrukt::Cache-&#62;write_cache($Konstrukt::File-&#62;absolute_path(&#39;another_file&#39;),      &#60;parse tree 2&#62;);
        $Konstrukt::Cache-&#62;write_cache($Konstrukt::File-&#62;absolute_path(&#39;even_another_file&#39;), &#60;parse tree 3&#62;);</pre>

<p>A cache for all 3 files will be written.</p>

<p>File 1) will have a date condition (+5m) and a file date condition for every file that has been read (with read_and_track) while file 1) has been tracked. That will be &#34;/some/file&#34; itself and &#34;/some/file/another_file&#34; (and also &#34;/konstrukt.settings&#34; as it is supposed that a settings change will invalidate all cached results).</p>

<p>File 2) will have a date condition (+2m) and file conditions only for itself (and for &#34;/konstrukt.settings&#34;).</p>

<p>File 3) will have no cache conditions as it has not been opened with &#34;read_and_track&#34;.</p>

<p>Note that <a href="#get_cache" class="podlinkpod"
>&#34;get_cache&#34;</a> has a similar effect as &#60;Konstrukt::File/read_and_track&#62;.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="CONFIGURATION"
>CONFIGURATION</a></h1>

<p>You may define those settings. Defaults:</p>

<pre>        cache/use       1          #Use cache:    0=never; 1=if exist
        cache/create    1          #Create cache: 0=never; 1=auto; 2=always
        cache/dir       ../cache/  #Directory to store the cached files in. Should end with a /. Relative to your document root
        cache/file_ext  .cached    #File extension for cached files</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="METHODS"
>METHODS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="new"
>new</a></h2>

<p>Constructor of this class</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init"
>init</a></h2>

<p>Initialization of this class</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_condition_file"
>add_condition_file</a></h2>

<p>Add a condition, that checks whether a file has been modified.</p>

<p><b>Parameters</b>:</p>

<ul>
<li>$watch_file - The <b>absolute</b> path to the file that should be checked for changes.</li>
</ul>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_condition_date"
>add_condition_date</a></h2>

<p>Add a condition, that checks whether the given date has been reached yet or not.</p>

<p><b>Parameters</b>:</p>

<ul>
<li>$date - The date. Absolute and relative dates allowed. Format: <code>YYYY-MM-DD-HH-MM-SS (absolute date)</code>, <code>+1Y 1M 1D 1h 1m 1s (relative date)</code>.
<pre>        Note that only positive date differences are allowed.
        Algebraic signs will not work. The format is B&#60;case sensitive&#62;!</pre>
</li>
</ul>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_condition_sql"
>add_condition_sql</a></h2>

<p>Add a condition, that checks whether an SQL-table has been modified or not.</p>

<p>The sql connection settings from your konstrukt.config will be used.</p>

<p>Note that the specified table <b>must</b> have a column named &#34;timestamp&#34;, which must be kept up to date on UPDATE and INSERT operations.</p>

<p>This may lead into problems as DELETE operations may not be recognized this way, because the appropriate row just disappears and the youngest timestamp may stay unmodified. You may get around this by inserting a dummy row with no content and just a timestamp that you manually keep up to date.</p>

<p>Note that the column type TIMESTAMP (e.g. in MySQL) will be updated on each UPDATE and INSERT operation.</p>

<p><b>Parameters</b>:</p>

<ul>
<li>$table - The table for which the youngest timestamp will be checked.</li>
</ul>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_condition_sql_advanced"
>add_condition_sql_advanced</a></h2>

<p>This one does the same as <a href="#add_condition_sql" class="podlinkpod"
>&#34;add_condition_sql&#34;</a> but lets you define the sql connection settings yourself.</p>

<p><b>Parameters</b>:</p>

<ul>
<li>$source - The DBI-source.</li>

<li>$user - The username for the DB logon.</li>

<li>$pass - The password for the DB logon.</li>

<li>$table - The table for which the youngest timestamp will be checked.</li>
</ul>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_condition_perl"
>add_condition_perl</a></h2>

<p>Adds a condition, that will execute (eval) the passed perl code and will assume a valid cache on a &#34;true&#34; result and discard the cache otherwise.</p>

<p><b>Parameters</b>:</p>

<ul>
<li>$code - The perl code that should be executed.</li>
</ul>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="prevent_caching"
>prevent_caching</a></h2>

<p>Prevents the caching of a file.</p>

<p>You may pass a reason, why the cache creation should be prevented.</p>

<p><b>Parameters</b>:</p>

<ul>
<li>$file - The <b>absolute</b> filename of the file that should be cached.</li>

<li>$reason - An integer which defines the reason for the cache prevention:
<ul>
<li>0: No reason</li>

<li>1: Errors during the processing of this file</li>

<li>2: Already using a cached file. Don&#39;t cache again.</li>
</ul>
</li>
</ul>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="validate_cache"
>validate_cache</a></h2>

<p>Takes a cache-file and validates it with the contained conditions. Returns true on a valid cache-file.</p>

<p><b>Parameters</b>:</p>

<ul>
<li>$tree - The content of the cache file (Reference to the root node).</li>
</ul>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_cache"
>get_cache</a></h2>

<p>Returns the cached results for a given file, if existent and valid. Returns undef otherwise.</p>

<p>Will also add the path to the requested file to the stack of current directories, <b>if</b> there is a valid cached file available.</p>

<p>So you should call <code>$Konstrukt::File-</code>pop()&#62; when you&#39;re done with the file you read from the cache.</p>

<p><b>Parameters</b>:</p>

<ul>
<li>$filename - The <b>absolute</b> path to the file for which we want to get the cached results.</li>
</ul>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="write_cache"
>write_cache</a></h2>

<p>Writes cached results for a given file to disk</p>

<p><b>Parameters</b>:</p>

<ul>
<li>$file - The <b>absolute</b> path (relative will not work) to the file for which we want to save the cached results.</li>

<li>$tree - The result tree of the prepare-run of the parser.</li>
</ul>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="delete_cache"
>delete_cache</a></h2>

<p>Deletes the cache for a given file.</p>

<p><b>Parameters</b>:</p>

<ul>
<li>$file - The <b>absolute</b> path to the file for which the results have been cached</li>
</ul>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Copyright 2006 Thomas Wittek (mail at gedankenkonstrukt dot de). All rights reserved.</p>

<p>This document is free software. It is distributed under the same terms as Perl itself.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<p><a href="../Konstrukt/File.html" class="podlinkpod"
>Konstrukt::File</a>, <a href="../Konstrukt/Plugin/template.html" class="podlinkpod"
>Konstrukt::Plugin::template</a>, <a href="../Konstrukt.html" class="podlinkpod"
>Konstrukt</a></p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
